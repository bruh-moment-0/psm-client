{% extends "base.html" %}
{% block content %}
<a href="/settings">settings</a>
<a href="/logout">logout</a>
<h2>PSM CLIENT SERVER MAIN MESSAGING PAGE</h2>
<h4>logged in as {{ username }}</h4>

<div id="sidebar">
    <h3>usernames list</h3>
    <ul id="usernameList"></ul>
    <input type="text" id="newUsername" placeholder="enter new username">
    <button onclick="addUsername()">add</button>
    <button onclick="deleteUsername()">delete selected username</button>
</div>

<div id="mainchatarea">
    <textarea id="serverText" readonly></textarea>
    <div id="scrolledText"></div>
    <input type="text" id="msgInputBox" placeholder="enter message...">
    <button onclick="sendMessage()">send</button>
    <button onclick="getMessage()">refresh</button>
</div>

<script>
    const ws = new WebSocket(`ws://${location.host}/ws`);
    const scrolledText = document.getElementById("scrolledText");
    const serverText = document.getElementById("serverText");
    const usernameList = document.getElementById("usernameList");
    let selectedUsername = null;
    let isRefreshing = false;
    let refreshTimer = null;
    const currentUser = "{{ username }}";

    async function loadContacts() {
        const res = await fetch(`/contacts/${currentUser}`);
        const data = await res.json();
        createList(data.contacts);
    }

    function createList(contacts) {
        usernameList.innerHTML = "";
        contacts.forEach(contact => {
            const li = document.createElement("li");
            li.id = `user-${contact}`;
            li.textContent = contact;
            li.style.cursor = "pointer";
            li.onclick = () => selectUsername(contact);
            usernameList.appendChild(li);
        });
    }

    ws.onmessage = (event) => {
        const data = JSON.parse(event.data);
        scrolledText.innerHTML = data.lines.map(line => `<div>${line}</div>`).join("");
        scrolledText.scrollTop = scrolledText.scrollHeight;
        serverText.value = data.apistat.join("\n");
        serverText.scrollTop = serverText.scrollHeight;
        isRefreshing = false;
        refreshLoop();
    };

    async function addUsername() {
        const newUsername = document.getElementById("newUsername").value.trim();
        if (!newUsername) return alert("please enter a username.");
        if (document.getElementById(`user-${newUsername}`)) return alert("username already exists.");
        const formData = new FormData();
        formData.append("username", currentUser);
        formData.append("new_contact", newUsername);
        const res = await fetch("/contacts/add", { method: "POST", body: formData });
        const data = await res.json();
        createList(data.contacts);
        document.getElementById("newUsername").value = "";
    }

    async function deleteUsername() {
    if (!selectedUsername) return alert("no username selected.");
        const formData = new FormData();
        formData.append("username", currentUser);
        formData.append("del_contact", selectedUsername);
        const res = await fetch("/contacts/delete", { method: "POST", body: formData });
        const data = await res.json();
        createList(data.contacts);
        selectedUsername = null;
        document.getElementById("scrolledText").innerHTML = "";
    }

    function selectUsername(username) {
        selectedUsername = username;
        for (const li of usernameList.children) {
            li.style.fontWeight = (li.textContent === username) ? "bold" : "normal";
        }
        getMessage();
    }

    function sendMessage() {
        const message = document.getElementById("msgInputBox").value.trim();
        if (!selectedUsername) return alert("Please select a username first.");
        if (!message) return alert("Message cannot be empty.");
        ws.send(JSON.stringify({
            action: "send",
            username: selectedUsername,
            message: message
        }));
        document.getElementById("msgInputBox").value = "";
    }

    function getMessage() {
        if (!selectedUsername) return;
        if (isRefreshing) return;
        isRefreshing = true;
        ws.send(JSON.stringify({
            action: "get",
            username: selectedUsername
        }));
    }

    function refreshLoop() {
        if (refreshTimer) clearTimeout(refreshTimer);
        refreshTimer = setTimeout(() => getMessage(), 750);
    }

    loadContacts();
    ws.onopen = () => refreshLoop();
</script>
{% endblock %}
