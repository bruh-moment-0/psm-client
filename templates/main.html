{% extends "base.html" %}
{% block content %}
<a href="/settings">settings</a>
<a href="/logout">logout</a>
<h2>PSM CLIENT SERVER MAIN MESSAGING PAGE</h2>
<h4>logged in as {{ username }}</h4>

<textarea id="serverText" readonly></textarea>

<textarea id="scrolledText" readonly></textarea>
    <input type="text" id="msgInputBox" placeholder="enter message...">
    <input type="text" id="userInputBox" placeholder="enter username...">
    <button onclick="sendMessage()">Send</button>
    <button onclick="getMessage()">Refresh</button>

<script>
    const ws = new WebSocket(`ws://${location.host}/ws`);
    const scrolledText = document.getElementById("scrolledText");
    const serverText = document.getElementById("serverText");
    let isRefreshing = false;
    let refreshTimer = null;
    ws.onmessage = (event) => {
        const data = JSON.parse(event.data);
        scrolledText.value = data.lines.join("\n");
        scrolledText.scrollTop = scrolledText.scrollHeight;
        serverText.value = data.apistat.join("\n");
        serverText.scrollTop = serverText.scrollHeight;
        isRefreshing = false;
        refreshLoop();
    };
    function sendMessage() {
        const message = document.getElementById("msgInputBox").value;
        const username = document.getElementById("userInputBox").value;
        if (message.trim() !== "" && username.trim() !== "") {
            ws.send(JSON.stringify({action: "send", username: username, message: message}));
            document.getElementById("msgInputBox").value = "";
        } else {
            alert("username or message empty");
        }
    }
    function getMessage() {
        const username = document.getElementById("userInputBox").value;
        if (!isRefreshing) {
            isRefreshing = true;
            ws.send(JSON.stringify({action: "get", username: username.trim()})); // Uncaught TypeError: Cannot read properties of undefined (reading 'join') at ws.onmessage
        }
    }
    function refreshLoop() {
        if (refreshTimer) clearTimeout(refreshTimer);
        refreshTimer = setTimeout(() => {
            getMessage();
        }, 750);
    }
    function remove() {
        ws.send(JSON.stringify({action: "removeaccount"}));
    }
    ws.onopen = () => {
        refreshLoop();
    };
</script>

{% endblock %}